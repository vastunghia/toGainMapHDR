# .github/workflows/test.yml
#
# Test automatici per toGainMapHDR
# Eseguiti su macOS 15.x e macOS 26.x tramite GitHub Actions
#
# Strategia binari:
#   macOS 15 → usa il binario precompilato in bin/toGainMapHDR
#              (il codice sorgente usa API macOS 26 e non compila con SDK 15)
#   macOS 26 → compila dai sorgenti tramite xcodebuild

name: Test toGainMapHDR

on:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-15
          - macos-26

    steps:

      # ── 1. Checkout ──────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2a. [macOS 26] Ricava il nome dello scheme ────────────────────────────
      - name: Detect scheme name (macOS 26 only)
        id: scheme
        if: matrix.os == 'macos-26'
        run: |
          SCHEME=$(
            xcodebuild -project toGainMapHDR.xcodeproj -list 2>/dev/null \
              | awk '/Schemes:/{ found=1; next } found && /^[[:space:]]+[^[:space:]]/ { gsub(/^[[:space:]]+/,"",$0); print; exit }'
          )
          echo "Scheme rilevato: '$SCHEME'"
          echo "name=$SCHEME" >> "$GITHUB_OUTPUT"

      # ── 2b. [macOS 26] Build dai sorgenti ─────────────────────────────────────
      - name: Build from source (macOS 26 only)
        if: matrix.os == 'macos-26'
        run: |
          set -o pipefail
          xcodebuild \
            -project toGainMapHDR.xcodeproj \
            -scheme "${{ steps.scheme.outputs.name }}" \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee build_log.txt || (grep -E "^.*error:" build_log.txt; exit 1)

      # ── 3a. [macOS 26] Individua e registra il binario appena compilato ───────
      - name: Locate compiled binary (macOS 26 only)
        id: locate_compiled
        if: matrix.os == 'macos-26'
        run: |
          BINARY=$(find build/DerivedData -name "toGainMapHDR" -type f | head -1)
          if [ -z "$BINARY" ]; then
            echo "ERROR: binario non trovato dopo la build!"
            find build/DerivedData -type f | head -30
            exit 1
          fi
          chmod +x "$BINARY"
          echo "binary=$BINARY" >> "$GITHUB_OUTPUT"
          echo "Binary compilato: $BINARY"
          # Copia la .metallib nella stessa directory del binario (richiesta a runtime)
          cp bin/GainMapKernel.ci.metallib "$(dirname "$BINARY")/"

      # ── 3b. [macOS 15] Usa il binario precompilato dal repo ───────────────────
      - name: Use prebuilt binary (macOS 15 only)
        id: locate_prebuilt
        if: matrix.os == 'macos-15'
        run: |
          BINARY="bin/toGainMapHDR"
          chmod +x "$BINARY"
          echo "binary=$BINARY" >> "$GITHUB_OUTPUT"
          echo "Binario precompilato: $BINARY"
          # La .metallib è già nella stessa cartella bin/, nessuna copia necessaria

      # ── 4. Unifica il percorso del binario nei due casi ───────────────────────
      - name: Set binary path
        id: binary
        run: |
          if [ "${{ matrix.os }}" = "macos-26" ]; then
            echo "path=${{ steps.locate_compiled.outputs.binary }}" >> "$GITHUB_OUTPUT"
          else
            echo "path=${{ steps.locate_prebuilt.outputs.binary }}" >> "$GITHUB_OUTPUT"
          fi

      # ── 5. Prepara cartella di output ─────────────────────────────────────────
      - name: Prepare output directory
        run: mkdir -p test_outputs

      # ── 6. Definisce la label dell'OS per i nomi file ─────────────────────────
      - name: Set OS label
        id: oslabel
        run: |
          RAW="${{ matrix.os }}"
          LABEL="${RAW//-/_}"
          echo "label=$LABEL" >> "$GITHUB_OUTPUT"

      # ── 7. Esegui i test ──────────────────────────────────────────────────────
      - name: Run tests
        env:
          BIN: ${{ steps.binary.outputs.path }}
          OS_LABEL: ${{ steps.oslabel.outputs.label }}
          INPUT: tests/fixtures/test_input.png
          OUTDIR: test_outputs
        run: |
          set -e

          run_test() {
            local suffix="$1"
            shift
            local flags=("$@")
            echo "──────────────────────────────────────────"
            echo "▶ Test: $suffix  |  flags: ${flags[*]}"
            "$BIN" "$INPUT" "$OUTDIR" "${flags[@]}" -t "${OS_LABEL}_${suffix}"
            echo "✓ OK"
          }

          run_test "def"
          run_test "def_d10"    -d 10
          run_test "def_H2.0"   -H 2.0
          run_test "def_d10_H2.0"   -d 10 -H 2.0
          run_test "g"        -g
          run_test "g_d10"    -g -d 10
          run_test "g_H2.0"   -g -H 2.0
          run_test "g_d10_H2.0"   -g -d 10 -H 2.0
          run_test "a"        -a
          run_test "a_d10"    -a -d 10
          run_test "a_H2.0"   -a -H 2.0
          run_test "a_d10_H2.0"   -a -d 10 -H 2.0

      # ── 8. Lista i file prodotti ──────────────────────────────────────────────
      - name: List output files
        run: |
          echo "══════════ Output files ══════════"
          ls -lh test_outputs/
          echo "══════════════════════════════════"

      # ── 9. Verifica che almeno un file sia stato generato ─────────────────────
      - name: Assert outputs exist
        run: |
          COUNT=$(find test_outputs -type f \( -name "*.heic" -o -name "*.jpg" \) | wc -l | tr -d ' ')
          echo "File di output trovati: $COUNT"
          if [ "$COUNT" -lt 1 ]; then
            echo "ERROR: Nessun file di output generato!"
            exit 1
          fi

      # ── 10. Upload degli artefatti ────────────────────────────────────────────
      - name: Upload test outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-outputs-${{ matrix.os }}
          path: test_outputs/
          retention-days: 30